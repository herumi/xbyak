
    C++ντ¨x86(IA-32), x64(AMD64, x86-64) JITεβΆεβ»εγ³εγΜε¦« Xbyak version 2.24

-----------------------------------------------------------------------------
γχΌθ¦¤κ¦

εαΖε£μεα―x86, x64(AMD64, x86-64)εα®εγάε¤Ήεγ³π¬άηΒΏθ½¤εβΔιΘ΅λθΐε΅ωεβµ¤++εα®εβ―εγ©εβΉεγ©εβ¤εγΜε¦«εγεα§εαρΌ
εγΞε¦―εβ°εγ©εγ κ°ήκ΅ΈθΡβεα«ιλΚιΣδεα«εβΆεβ»εγ³εγΜε¦­εαε£λεαΖεΆεαΈηΎ±ογ½εα§εαρΌ

-----------------------------------------------------------------------------
γχΌι²»κΐ΄

εγ»εγΠε¥γεγ€εγΚε¤£εβ¤εγ«εβεγ³εγεγΌ
    xbyak.hεβΔε¤¦εγ³εβ―εγ«εγΌεγ²ε΅ωεβ¶εΆΆεαΒεΆ©εαε΅πιθ©ντ¨εαε£λεαΖεΆεαΈεΆ©εαΊεΆΐεαρΌ
    C++εα®λώ ξ·¨εΆΑιζεΆ©ρφ²ε΅ψεα¦εα¨ε£λεαήε£αώΎΈη¤Μλ¦εβΆεβ»εγ³εγΜε¦«εα―θΊΊκ¦ΆεΆ©εαρΌ
    32bit/64bitθΊ΅κ±ΎκΑΨεΆ©εαρΌ
    κ±ΎκΑΨε¥λεγΌεγΆεγ¶ε¥γεβ―:νιΉμ©ιρ½θ½¤ρω¤εα½Ω86, MMX/MMX2/SSE/SSE2/SSE3/SSSE3/SSE4/FPU(θΊ€ργ¨)

εγ»Windows Xp(32bit, 64bit), Vista/Linux(32bit, 64bit)/Intel Macκ±ΎκΑ
    Windows XpθΊ΄εΆ©εα―VC2005 Express Ed., VC2008
    Windows Vista
    Linux (kernel 2.4.32)θΊ΄εΆ©εα―gcc 4.3.0, CentOS 5.1θΊ΄εΆ©εα―gcc 4.1.2
    Intel Mac
    εαεα©εα§ιλΚζ½ΨιΆΊπ¬Ίε£ςεαΞεΆ¨εα¨εΆΐεαρΌ

γΰ» gccεα§εα―and, or, xorεαεα©εβΔθΌΘι®Ξη­ΐεΆεαΞεΆ¨π©£ρη°ε΅χεα¦εαΞεΆΐεα¬εΆ΅εβΆρΌ
-fno-operator-namesεβεγΞε¤Ήεγ§εγ³εβΔκΏ½ικ εαΞεΆ¨εβ³εγ³εγΒε¤¦εγ«εαΞεΆ¨εαΎεΆΆεαΚε΅δώΎ

-----------------------------------------------------------------------------
γχΌθΊΜη£ω
xbyak.h
xbyak_bin2hex.h
xbyak_mnemonic.h
εαΖε£μεβ²ε£ςιπΈζΈ€εα®εγΒε¤»εα«ιε¥εβΈεΆ¨εβ¤εγ³εβ―εγ«εγΌεγ²ε¥ρεβΉεα«πΑ½ικ εαΞεΆ¨εαΎεΆΆεαΚε΅δώΎ

Linuxεα§εα―make installεα§/usr/local/include/xbyakεα«εβ³εγΘε¦ΎεαΚε£μεαΎεαρΌ
-----------------------------------------------------------------------------
γχΌθΛημµ•

Xbyak::CodeGenerator εβ―εγ©εβΉεβΔι¶θ²ΑεαΞρΌΈε΅ύεα®εβ―εγ©εβΉεγ΅εβ½εγ¦ε¥ιιζεΆ©x86, x64εβΆεβ»εγ³εγΜε¦«εβ’
πΠκΏ°εαΞεΆΐεαρΌΌε΅ύεα®εγ΅εβ½εγ¦ε¥ιεβΔηΒΎεα³ιηΊεαΞεΆ΅κΐΈρΌ·ΘetCode()εγ΅εβ½εγ¦ε¥ιεβΔηΒΎεα³ιηΊεαΞρΌΈε΅ύεα®λθ»
εβ΄η€¤εβΔκ®¬ιθ¬ε΅μθΏΏεα¨εΆ΅εα¨λΜ¤λυ°εγΪε¤¦εγ³εβΏεα«κ¦²θ½ϋεαΞεΆ¨ιθ©ντ¨εαΞεΆΐεαρΌΌε¤¤εβ»εγ³εγΜε¦­εβ¨εγ©εγΌεα―θΐ¶η¤–
εα«εβ°ε£κρΰΤιή§εαΚε£μεαΎεα™(cf. main.cpp)ώΎ

εγ»κ΅Ίλό¬νϊ¨εΆ­nasmεα®ιρ½θ½¤εα§λλ¬κΎ§εβΔεΆ¦εαΒε£μεα°εβ°ε΅δεα§εαρΌ

mov eax, ebx  --> mov(eax, ebx);
inc ecx           inc(ecx);
ret           --> ret();

εγ»εβΆεγ²ε¦®εγ¦ε¤Ήεγ³εβ°

(ptr|dword|word|byte) [base + index * (1|2|4|8) + displacement]
εα¨εα¨ε΅ζκΏΆεα§λμ®η®Τε΅χεαΎεαρΌΌε¤·εβ¤εβΊεβΔθ·ηκ°Τε΅ωεβ¶ηΏκ¦Άε΅μεαεα¨λΡπεβ³ΡtrεβΔζ½Ώεα°εΆ²εβ°ε΅δεα§εαρΌ
εβ»εγ¬εβ―εβΏεα―εβµεγΪε¦Ύεγ°ε΅χεα¦εα¨εΆΐεαΦε£σώΎ

mov eax, [ebx+ecx] --> mov (eax, ptr[ebx+ecx]);
test byte [esp], 4 --> test (byte [esp], 4);

(μµ¨λδ) dword, word, byteεα―εβ―εγ©εβΉκ¦²θΚ²εα§εαρΌΌηΎΖεΆ¥εα¦εαήεΆεα°εΆ²unsigned intεα®
εα¤εβ¤ε£κεα§dwordεβΓΥypedefεαΞεΆ¬εα¨εΆ©εαΎεΆΆεαΚε΅δώΎ

εγ»εγ©εγε¦­

L(λφ®η­Ξη―χ);
εα§κ°ΤιΎ©εαΞεΆΐεαρΌΌε¤Ίεγ£εγ³εγΞε΅ωεβ¶εΆεαΊεΆ±εαΪεΆ°λφ®η­Ξη―χεβΔθ·ηκ°Τε΅χεαΎεαρΌΌηΎΈθΜ»ιο¤ι©εβ¤ηΎ±ογ½εα§εαε΅μώΎ
νϋΈκ±ΎεβΆεγ²ε¦®εβΉεα8εγΖε¥γεγ°εΆ­ιοΌεΆΐεβ²εΆ¬εα¨η ΄ιπ°εΆ±T_NEARεβΔεΆ¦εαΒεΆ¬εα¨εΆκ°ήκ΅ΈθΡβεα«θΐ¶η¤Με΅μνωΊντ
εαΞεΆΐεαρΌ

εγ»hasUndefinedLabel()εβΔηΒΎεα³ιηΊεαΞεΆ¨νόήεΆ¬εβ²ε¤Ίεγ£εγ³εγΞη©θεαΈη­ΠηΨεαΞεΆ¬εα¨ε΅σεα¨εβΔι¤ΊεαΞεΆΐεαρΌ
εβ³εγΌεγ²ε£ςπ¨¶ιΦ¶εαΞεΆ¨εαΎεΆΆεαΚε΅δώΎ

L("L1");
    jmp ("L1");

    jmp ("L2");
    ...
    κ²Βε΅χεα®ιρ½θ½¤εα®κΆ΄ιπ°ρΌ
    ...
L("L2");

    jmp ("L3", T_NEAR);
    ...
    μ΄Άκ³±εα®ιρ½θ½¤εαΈε΅βεβ¶η ΄ιπ
    ...
L("L3");

<κΑΨιΘξΉ¨>

1. MASMεγ©εβ¤εβ―εα@@, @f, @bεβΔε¤·εγΪε¦Ύεγ

  L("@@"); // <A>
  jmp("@b"); // jmp to <A>
  jmp("@f"); // jmp to <B>
  L("@@"); // <B>
  jmp("@b"); // jmp to <B>

2. εγ©εγε¦­εα®κ³€λι€ιμ–

εγΘε¦¬εβεγ²εΆ©κ©¶εΆΐεβ¶ε¦«εγε¦­εβΓΚnLocalLabel(), outLocalLabel()εα§λμήε£ΰεαΖεΆεα§κ³€λι€ιμΜεΆ©εαΊεΆΐεαρΌ

void func1()
{
    inLocalLabel();
    L(".lp"); // <A>
    ...
    jmp(".lp"); // jmpt to <A>
    outLocalLabel();
}

void func2()
{
    L(".lp"); // <B>
    func1();
    jmp(".lp"); // jmp to <B>
}

θΊ΄κ¨Πε¤·εγ³εγΞε¦­εα§εα―inLocalLabel(), outLocalLabel()εαΈι¨£εα¨εΆώΎ
".lp"εγ©εγε¦­εα®θΌΈλ­νκ°ΤιΎ©εβ¨εγ©εγΌεα«εαεβ΄εΆΐεαρΌ

εγ»Xbyak::CodeGenerator()εβ³εγ³εβΉεγ°ε¦«εβ―εβΏεβ¤εγ³εβΏεγΚε¤©εγΌεβΉ

@param maxSize [in] εβ³εγΌεγ²ιΘ΅λθΐθΧΰκ¦§εβµεβ¤εβΊ(εγ®ε¥υεβ©εγ«εγ2048byte)
@param userPtr [in] εγ¦εγΌεβ¶λμ®η®Τε¦£εγΆεγ

CodeGenerator(size_t maxSize = DEFAULT_MAX_CODE_SIZE, void *userPtr = 0);

εγ®ε¥υεβ©εγ«εγ°ε¤µεγΌεγ²ε¤·εβ¤εβΊεα―2048(=DEFAULT_MAX_CODE_SIZE)εγΐε¤¦εγ°εΆ©εαρΌ
εαΪε£μεβ°ε£κκ¦§εαΊεΆ¬εβ³εγΌεγ²ε£ςντήθ―πεαε£λκΆ΄ιπ°εΆ±CodeGenerator()εα®εβ³εγ³εβΉεγ°ε¦«εβ―εβΏεα«λμ®η®Τε΅χεα¦εαΎεΆΆεαΚε΅δώΎ

class Quantize : public Xbyak::CodeGenerator {
public:
    Quantize()
        : CodeGenerator(8192)
    {
    }
    ...
};

# ιλΚιΣδεα«εαΞεΆ΅εα»εα¬ε΅μεβ°ε΅δεα®εα εαΈη®ήκ΅Έη±άθ€§εα®ξ°΅νπ¬ε΅μρύΆιΰΔεΆ©εβ¨εΆ¥εα¦εαΎεαΦε£σγΰ¦ώΎ

εαΎεαήε¦¨εγΌεβ¶λμ®η®Τε¦£εγΆεγεβΔε¤µεγΌεγ²ιΘ΅λθΐθΧΰκ¦§εβµεβ¤εβΊεα¨ιε±εα«λμ®η®Τε΅ωεβ¶εΆώΎ·¤odeGeneratorεα―
λμ®η®Τε΅υεβΈεΆ΅εγ΅εγΆεγθΊ΄εΆ­εγΐε¤¦εγ°η―χεβΔιΘ΅λθΐε΅χεαΎεαρΌ

εβµεγΪε¦Ύεγ°λΜ¤λυ°εα¨εαΞεΆ¨λμ®η®Τε΅υεβΈεΆ΅εβΆεγ²ε¦®εβΉεα®κ°ήκ΅Έη±άθ€§εβΔη¤²θΦ¶εαε£λCodeArray::protect()εα¨
θΊΌε΅θεβ²ε£μεαήε¥ύεβ¤εγ³εβΏεα¶ε£ιεβΆεγ©εβ¤εγ΅εγ³εγ°ε΅υεβΈεΆ΅εγΪε¤¦εγ³εβΏεβΔη½φκΐΞε΅ωεβµ¤odeArray::getAlignedAddress()
εβ¤ιΘλδΎε΅χεαΎεαΞεΆ΅ώΎΌκ©³ξ¶°εα―sample/test0.cppεα®use memory allocated by userεβΔη½βοΰ¦εΆ­
εαΞεΆ¨εαΎεΆΆεαΚε΅δώΎ

/**
    change exec permission of memory
    @param addr [in] buffer address
    @param size [in] buffer size
    @param canExec [in] true(enable to exec), false(disable to exec)
    @return true(success), false(failure)
*/
bool CodeArray::protect(const void *addr, size_t size, bool canExec);

/**
    get aligned memory pointer
*/
uint8 *CodeArray::getAlignedAddress(uint8 *addr, size_t alignedSize = ALIGN_SIZE);

εαΪεΆ°θ½Μκ©³ξ¶°εα―ιπ¨ι¨®εβµεγ³εγΞε¦­εβΔη½βνε§εαΞεΆ¨εαΎεΆΆεαΚε΅δώΎ
-----------------------------------------------------------------------------
γχΌε¥ώεβ―εγ­

32bitνς°κ¤¦ζΈ΄εΆ©εβ³εγ³εγΒε¤¦εγ«εαε£λεα¨XBYAK32εαΈρΌ64bitνς°κ¤¦ζΈ΄εΆ©εβ³εγ³εγΒε¤¦εγ«εαε£λεα¨XBYAK64εα
κ°ΤιΎ©εαΚε£μεαΎεαρΌΌε΅υεβ²εΆ­64bitνς°κ¤¦ζΈ΄εΆ©εα―Windowsεαεβ±ΉBYAK64_WINώΎ·ΘccθΊ΄εΆ©εα―XBYAK64_GCC
εβ¤η®ΤιΎ©εαΚε£μεαΎεαρΌ

-----------------------------------------------------------------------------
γχΌζ½Ώντ¨θΐ‹

test0.cpp ; ξ²΅ινΠεΆ¬θΐ‹(x86, x64)
quantize.cpp ; ιι²εβ΄ι®ΞεΆ°JITεβΆεβ»εγ³εγΜε¦­εα«εβ°ε£λρηΎη­ΐη·φεα®ς­Πλ€ήη·φ(x86)
calc.cpp ; θΊΌε΅θεβ²ε£μεαήη¤Τλ ηΌΎε£ςεβΆεβ»εγ³εγΜε¦­εαΞεΆ¨κ°ήκ΅(x86, x64)
           boost(http://www.boost.org/)εαΈηΏκ¦
bf.cpp ; JIT Brainfuck(x86, x64)

-----------------------------------------------------------------------------
γχΌθ³¨λδ

MMX/SSEιρ½θ½¤εα―εα»εαΌιε¨εα¦κ°ήκ£ε΅υεβΈεΆ¨εα¨εΆΐεαε΅μώΎ3D Now!ιρ½θ½¤εβ¨ρΌΈζΈ€ργ¨εα®νιΉμ°΄εΆ¬
ιρ½θ½¤εα―νοΎλω¤ι¤»εα§εα―κ°ήκ£ε΅υεβΈεΆ¨εα¨εΆΐεαΦε£σώΎ»§PUεα®80bitμ·®ιλΚη°ΎθΚ²εα―εβµεγΪε¦Ύεγ°ε΅χεα¦εα¨εΆΐεαΦε£σώΎ

θΏΚε΅λεαΘκ¦ΆθΧϋεαΈε΅βεβΈεΆ²εαΘλ€£ξ·΅εαΎεΆΆεαΚε΅δώΎ

-----------------------------------------------------------------------------
γχΌε¦«εβ¤εβ»εγ³εβΉ

θΑ®μ―£εαΚε£μεαήθΜ²εαΞε΅δBSDεγ©εβ¤εβ»εγ³εβΉεα«κΐΖε΅δεαΎεαρΌ
http://www.opensource.jp/licenses/bsd-license.html

sample/{echo,hello}.bfεα― http://www.kmonos.net/alang/etc/brainfuck.php εα¶ε£ι
εα¨εΆ΅εα εαΊεΆΐεαΞεΆ΅ώΎ

-----------------------------------------------------------------------------
γχΌη±¥μ―΄

2010/04/16 ver 2.24 change the prototype of rewrite() method
2010/04/15 ver 2.23 fix align() and xbyak_util.h for Mac
2010/02/16 ver 2.22 fix inLocalLabel()/outLocalLabel()
2009/12/09 ver 2.21 support cygwin(gcc 4.3.2)
2009/11/28 ver 2.20 FPUεα®θΊ€ργ¨ιρ½θ½¤εβµεγΪε¦Ύεγ
2009/06/25 ver 2.11 64bitεγΆεγΌεγ²εΆ©εα® mov(qword[rax], imm); θΑ®μ―£(thanks to MartinεαΚε£σ)
2009/03/10 ver 2.10 jmp/call reg64εα®ιζΞλΚΉεαREG.Wιι΄λ¦
2009/02/24 ver 2.09 movq reg64, mmx/xmm; movq mmx/xmm, reg64πΑ½ικ 
2009/02/13 ver 2.08 movd(xmm7, dword[eax])εα0x66εβΔκΐΏεα¨εαε¥πεβ°θΑ®μ―£(thanks to GabestεαΚε£σ)
2008/12/30 ver 2.07 call()εα®νϋΈκ±ΎεβΆεγ²ε¦®εβΉεα8bitθ½¥θΊ¶εΆ°εα¨εαΊεΆ°εγΐε¤²θΑ®μ―£(thanks to katoεαΚε£σ)
2008/09/18 ver 2.06 @@, @f, @bεα¨εγ©εγε¦­εα®κ³€λι€ιμΜθ©ήκ¦ΏπΑ½ικ (thanks to nobu-qεαΚε£σ)
2008/09/18 ver 2.05 ptr [rip + 32bit offset]εβµεγΪε¦Ύεγ(thanks to ιϋ£κ―ΐηΌ(Dango-Chu)εαΚε£σ)
2008/06/03 ver 2.04 align()εα®εγΪε¤­εγήε¤»θΑ®μ―£ώΎ»Ξov(ptr[eax],1);εαεα©εβΔε¤εγ©εγΌεα«
2008/06/02 ver 2.03 εγ¦εγΌεβ¶κ°ΤιΎ©εγ΅εγΆεγεβ¤εγ³εβΏεγΚε¤©εγΌεβΉεβµεγΪε¦Ύεγ
2008/05/26 ver 2.02 protect()(on Linux)εα§θΊΊθ­£εαπ­κ°ΤεΆ­εαεβ¶ε΅σεα¨εαΈε΅βεβ¶εΆ°εβΔζΏ®μ―£(thanks to sinichiro_hεαΚε£σ)
2008/04/30 ver 2.01 cmpxchg16b, cdqeπΑ½ικ 
2008/04/29 ver 2.00 x86/x64-64νι°η®ρφ‹
2008/04/25 ver 1.90 x86νι°Π²ιε¬ρφ‹
2008/04/18 ver 1.12 εβ³εγΌεγ²θΚ¶νπ†
2008/04/14 ver 1.11 εβ³εγΌεγ²θΚ¶νπ†
2008/03/12 ver 1.10 bsf/bsrπΑ½ικ (κΑΠε£μεα¦εα¨εΆ΅)
2008/02/14 ver 1.09 sub eax, 1234εα16bitεγΆεγΌεγ²εΆ©ιηΊικΦε΅υεβΈεΆ¨εα¨εΆ΅εα®εβΔζΏ®μ―£(thanks to RobertεαΚε£σ)
2007/11/05 ver 1.08 lock, xadd, xchgπΑ½ικ 
2007/11/02 ver 1.07 SSSE3/SSE4κ±ΎκΑ(thanks to ιϋ£κ―ΐηΌ(Dango-Chu)εαΚε£σ)
2007/09/25 ver 1.06 call((int)ρφΆλυ°εγΪε¤¦εγ³εβΏ); jmp((int)ρφΆλυ°εγΪε¤¦εγ³εβΏ);εα®εβµεγΪε¦Ύεγ
2007/08/04 ver 1.05 ξ¶°εα¶ε΅δθΑ®μ―£
2007/02/04 κΐΈθΜ»εαΈεα®εβΈεγ£εγ³εγΞεΆ©T_NEARεβΔεΆ¦εαΒεΆ¬εα¨εΆεαΊεΆ­8bitνϋΈκ±ΎεβΆεγ²ε¦®εβΉεα«ιε¥εβ²εΆ¬εα„
           κΆ΄ιπ°εΆ­θΐ¶η¤Με΅μνωΊντήε΅χεαεα¨ε¥πεβ°εα®θΑ®μ―£
2007/01/21 [disp]εα®κΏΆεα®εβΆεγ²ε¦®εβΉντήθ―πεα®εγΐε¤²θΑ®μ―£
           mov (eax|ax|al, [disp]); mov([disp], eax|ax|al);εα®ξ΅­εα¨κ΅¨νοΎραΈλκ
2007/01/17 webεγΤε¦ΎεβΈθΏΨθ―π
2007/01/04 ιε¬ρφ¶λΛλκ©‹

-----------------------------------------------------------------------------
γχΌκΑχθΏΨθ¨©οΰ…

ιε²θ―πμ½¶ιΘ΅(MITSUNARI Shigeo, herumi at nifty dot com)

---
$Revision: 1.56 $
$Date: 2010/04/16 11:58:22 $
